<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BOI MUSIC</title>
  <style>
    :root{
      --bg:#0b0f12; --panel:#0f1720; --muted:#9aa4ad; --accent:#1db954;
      --card:#0d1518; --glass: rgba(255,255,255,0.03);
    }
    *{box‚Äësizing:border-box}
    html,body{
      height:100%;
      margin:0;
      font-family:Inter, "Segoe UI", Roboto, Arial;
      background:var(--bg);
      color:#e6eef3;
    }
    .app{
      display:grid;
      grid-template-columns:260px 1fr;
      gap:18px;
      height:100vh;
      padding:18px;
      transition:all .28s ease;
    }
    .sidebar{
      background:var(--panel);
      border-radius:12px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      height:calc(100vh - 36px);
      overflow:auto;
    }
    .logo{
      font-weight:700;
      font-size:18px;
      color:var(--accent);
      letter-spacing:0.6px;
    }
    .side-section{margin-top:8px}
    .playlist-item{
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px;
      border-radius:8px;
      cursor:pointer;
    }
    .playlist-item:hover{background:var(--glass)}
    .btn{
      background:transparent;
      border:1px solid rgba(255,255,255,0.04);
      padding:8px 10px;
      border-radius:8px;
      color:var(--muted);
      cursor:pointer;
    }
    .btn-primary{
      background:var(--accent);
      color:#02140b;
      border:none;
      font-weight:600;
    }
    .main{
      display:flex;
      flex-direction:column;
      height:100vh;
    }
    .topbar {
      flex:0 0 60px;
      min-height:60px;
      max-height:60px;
    }
    .search{
      display:flex;
      gap:8px;
      align-items:center;
      width:100%;
      position:relative;
    }
    .search input{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      background:#07121a;
      color:#eaf6ee;
    }
    .content-wrapper{
      display:flex;
      flex:1 1 auto;
      gap:12px;
      overflow:hidden;
      align-items:stretch;
    }
    .left-main{
      display:flex;
      flex-direction:column;
      flex:1 1 0;
      min-width:0;
      overflow-y:auto;
    }
    .card{
      background:var(--card);
      padding:12px;
      border-radius:10px;
      overflow:auto;
    }
    .results{
      max-height:200px;
      overflow-y:auto;
    }
    .track-row{
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px;
      border-radius:10px;
      cursor:pointer;
    }
    .track-row:hover{background:var(--glass)}
    .track-thumb{
      width:72px;
      height:72px;
      border-radius:8px;
      flex:0 0 72px;
      object-fit:cover;
    }
    .track-meta{flex:1}
    .track-title{font-weight:600}
    .track-sub{
      color:var(--muted);
      font-size:13px;
      margin-top:4px;
    }
    .right-col{
      width:360px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow-y:auto;
      min-height:120px;
    }
    .queue-list{
      flex:1 1 auto;
      overflow-y:auto;
      min-height:120px;
    }
    .player-bar{
      flex:0 0 84px;
      border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      width:100%;
    }
    .player-left{
      display:flex;
      gap:12px;
      align-items:center;
      width:30%;
    }
    .player-thumb{
      width:64px;
      height:64px;
      border-radius:8px;
      object-fit:cover;
      background:#081018;
    }
    .player-controls{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      width:40%;
    }
    .control-btn{
      background:transparent;
      border:none;
      color:#eaf6ee;
      font-size:18px;
      cursor:pointer;
      padding:8px;
      border-radius:8px;
    }
    .control-btn:hover{background:var(--glass)}
    .small{font-size:13px}
    .muted{color:var(--muted)}
    .playlist-drawer{
      position:fixed;
      top:0;
      right:0;
      height:100vh;
      width:0;
      background:linear-gradient(180deg,#0e1b1f,#071217);
      border-radius:0 12px 12px 0;
      overflow:hidden;
      box-shadow:0 12px 40px rgba(0,0,0,0.6);
      transition:width .28s ease;
      display:flex;
      flex-direction:column;
      z-index:101;
    }
    .playlist-drawer.open{width:400px}
    .drawer-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    .drawer-body{
      padding:12px;
      overflow:auto;
      flex:1;
    }
    .drawer-footer{
      padding:12px;
      border-top:1px solid rgba(255,255,255,0.03);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .playlist-song{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px;
      border-radius:8px;
      margin-bottom:6px;
      background:transparent;
    }
    .song-meta{flex:1;margin-left:8px}
    .song-actions{display:flex;gap:6px;align-items:center}
    .highlight{background:rgba(29,185,84,0.12)}
    .close-btn{
      background:transparent;
      border:none;
      color:var(--muted);
      font-size:18px;
      cursor:pointer;
      padding:6px;
    }
    .fade-overlay{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:transparent;
      pointer-events:none;
      transition:background .28s ease;
      z-index:100;
    }
    .fade-overlay.visible{
      background:rgba(0,0,0,0.36);
      pointer-events:auto;
    }
    .playlist-controls{
      display:flex;
      gap:8px;
      align-items:center;
      margin-left:8px;
    }
    @media(max-width:1000px){
      .app{grid-template-columns:1fr}
      .sidebar{position:relative;z-index:3}
      .playlist-drawer.open{
        width:100vw;
        right:0;
        left:0;
        border-radius:0;
        top:0;
        height:100vh;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">BOI‚ÄØMUSIC</div>
      <div class="side-section card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Playlists</div>
          <div>
            <button class="btn" id="newPlaylistBtn">+ New</button>
            <button class="btn" id="deletePlaylistBtn">Delete</button>
          </div>
        </div>
        <div id="playlistsList" style="margin-top:8px"></div>
      </div>
      <div class="side-section card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Now Playing Queue</div>
        </div>
        <div style="margin-top:8px">
          <button class="btn" id="clearQueueBtn">Clear</button>
          <button class="btn" id="shuffleBtn">Shuffle</button>
        </div>
      </div>
      <div style="margin-top:auto;font-size:13px;color:var(--muted)">BOI MUSIC</div>
    </aside>
    <main class="main">
      <div class="topbar card">
        <div class="search">
          <input id="searchInput" placeholder="Search YouTube">
          <button class="btn btn-primary" id="searchBtn">Search</button>
        </div>
      </div>
      <div class="content-wrapper">
        <div class="left-main">
          <section class="card" style="margin-bottom:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><div style="font-weight:800;font-size:18px">Search Results</div></div>
            </div>
            <div id="results" class="results" style="margin-top:10px"></div>
          </section>
          <section class="card" style="flex:1;display:flex;flex-direction:column;gap:8px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Now Playing Queue</div>
              <div class="muted small">Queue length: <span id="queueCount">0</span></div>
            </div>
            <div id="queueList" class="queue-list" style="margin-top:6px"></div>
          </section>
        </div>
        <div class="right-col" style="min-width:0"></div>
      </div>
      <div class="player-bar">
        <div class="player-left">
          <img id="playerThumb" class="player-thumb" src="" alt="">
          <div>
            <div id="playerTitle" style="font-weight:700">Not playing</div>
            <div id="playerArtist" class="muted small">‚Äî</div>
            <div style="margin-top:6px">
              <button class="btn" id="addToPlaylistBtn">Add to Playlist</button>
            </div>
          </div>
        </div>
        <div class="player-controls">
          <button class="control-btn" id="prevBtn">‚èÆ</button>
          <button class="control-btn" id="playPauseBtn">‚ñ∂Ô∏è</button>
          <button class="control-btn" id="nextBtn">‚è≠</button>
          <button class="control-btn" id="repeatBtn">üîÅ</button>
          <button class="control-btn" id="repeatBtn"></button>
        </div>
        <div style="width:25%;text-align:right;padding-right:8px"></div>
      </div>
    </main>
  </div>
  
  <div id="customDialog" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z‚Äëindex:9999;font‚Äëfamily:Inter,'Segoe UI',Roboto,Arial;">
    <div style="background:#0b0f12;padding:20px;border-radius:12px;min-width:320px;color:#00ff55;display:flex;flex-direction:column;gap:12px;">
      <div id="customDialogMessage" style="font-weight:600;"></div>
      <input id="customDialogInput" style="display:none;width:90%;padding:8px;border-radius:6px;border:none;background:#202020;color:#00ff55;">
      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button id="customDialogOk" style="padding:6px 12px;border:none;border-radius:6px;background:#00ff55;color:#0b0f12;cursor:pointer;">OK</button>
        <button id="customDialogCancel" style="padding:6px 12px;border:none;border-radius:6px;background:#0b0f12;color:#00ff55;border:1px solid #00ff55;cursor:pointer;display:none;">Cancel</button>
      </div>
    </div>
  </div>
  
  <div id="playlistDrawer" class="playlist-drawer" aria-hidden="true">
    <div class="drawer-header">
      <div style="font-weight:800;color:var(--accent)">Playlist</div>
      <div>
        <button class="btn" id="playPlaylistBtn">Play Playlist</button>
        <button class="btn" id="togglePlaylistRepeatBtn">Repeat: <span id="playlistRepeatState">Off</span></button>
        <button class="close-btn" id="closeDrawerBtn" title="Close">‚úï</button>
      </div>
    </div>
    <div class="drawer-body">
      <div style="margin-bottom:8px">
        <div class="small muted">Selected playlist:</div>
        <div id="selectedPlaylistName" style="font-weight:700;margin-top:6px">None</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <select id="playlistAddSelect" style="flex:1;padding:8px;border-radius:8px;background:#091216;border:1px solid rgba(255,255,255,0.03);color:#eaf6ee"></select>
        <button class="btn" id="addCurrentToSelectedBtn">Add current</button>
        <button class="btn" id="createPlaylistFromDrawerBtn">New</button>
      </div>
      <div id="playlistSongs"></div>
    </div>
    <div class="drawer-footer">
      <div style="flex:1" class="muted small">Tip: delete a playlist via the left "Delete" button (requires typing exact name)</div>
      <div>
        <button class="btn" id="closeDrawerBtnFooter">Close</button>
      </div>
    </div>
  </div>
  
  <div id="fadeOverlay" class="fade-overlay"></div>

  <!-- replace: hidden youtube player container -->
  <div id="yt-player" style="position:absolute; left:0px; width:320px; height:180px;">
    <iframe id="embedPlayer"
            width="320" height="180"
            src=""
            frameborder="0"
            allow="accelerometer; autoplay; clipboard‚Äëwrite; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
    </iframe>
  </div>

  <script>
    // ---------- State ----------
    let embedIframe = document.getElementById('embedPlayer');
    let queue = [], currentIndex = -1, isPlaying = false;
    let repeatMode = 0; // 0=no repeat,1=repeat all,2=repeat one
    const repeatIcons = ["","üîÅ","üîÇ"];
    // playlists: { name: [ {videoId, title, channel, thumb}, ... ] }
    let playlists = JSON.parse(localStorage.getItem('BOIMUSIC_PLAYLISTS') || '{}');
    let selectedPlaylist = null;
    let playlistRepeat = false;

    // ---------- Search ----------
    async function searchSongs(q){
      const res = await fetch(`https://boi6741purpleturtle.hexorod0.workers.dev/?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      const ids = data.items || [];
      const videos = await Promise.all(ids.map(async id=>{
        try{
          const r = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${id}&format=json`);
          const info = await r.json();
          return { videoId:id, title:info.title, channel:info.author_name, thumb:info.thumbnail_url };
        } catch(e){
          return { videoId:id, title:"Unknown", channel:"", thumb:"" };
        }
      }));
      return videos;
    }

    document.getElementById('searchBtn').addEventListener('click', async ()=>{
      const q = document.getElementById('searchInput').value.trim();
      if(!q) return;
      const results = await searchSongs(q);
      const c = document.getElementById('results');
      c.innerHTML = '';
      results.forEach(item=>{
        const row = document.createElement('div');
        row.className = 'track-row';
        row.innerHTML = 
          `<img class="track-thumb" src="${item.thumb}">
           <div class="track-meta">
             <div class="track-title">${item.title}</div>
             <div class="track-sub">${item.channel}</div>
           </div>`;
        row.addEventListener('click', ()=> addToQueue(item));
        c.appendChild(row);
      });
    });

    // ---------- Queue ----------
    function addToQueue(item){
      queue.push(item);
      updateQueueUI();
      saveQueueToLocal();
      if(currentIndex === -1) playIndex(0);
    }
    function updateQueueUI(){
      const container = document.getElementById('queueList');
      container.innerHTML = '';
      queue.forEach((item,i)=>{
        const row = document.createElement('div');
        row.className='track-row';
        if(i===currentIndex) row.classList.add('highlight');
        row.innerHTML = `<div style="flex:0 0 36px;text-align:center">${i+1}</div><div class="track-meta">${item.title}</div>`;
        row.addEventListener('click', ()=> playIndex(i));
        container.appendChild(row);
      });
      document.getElementById('queueCount').textContent = queue.length;
    }
    document.getElementById('clearQueueBtn').addEventListener('click', ()=>{
      queue = []; currentIndex = -1; isPlaying = false;
      embedIframe.src = "";
      updateQueueUI(); saveQueueToLocal();
    });

   // ---------- Player (Embed) ----------
      function playIndex(idx){
        if(queue.length === 0) return;
        currentIndex = idx;
        const item = queue[idx];
        if(item && item.videoId){
          // Added enablejsapi=1 to allow postMessage events
          embedIframe.src = `https://www.youtube.com/embed/${item.videoId}?autoplay=1&rel=0&modestbranding=1&enablejsapi=1`;
        }
        document.getElementById('playerTitle').textContent = item.title || 'Loading...';
        document.getElementById('playerArtist').textContent = item.channel || '‚Äî';
        document.getElementById('playerThumb').src = item.thumb || '';
        isPlaying = true;
        updatePlayPauseBtn();
        updateQueueUI();
      }

      // ---------- Detect video end ----------
      window.addEventListener('message', (event) => {
        if(!event.origin.includes("youtube.com")) return;
        let data;
        try { data = JSON.parse(event.data); } catch(e){ return; }

        // YT event 0 = video ended
        if(data.event === 'onStateChange' && data.info === 0){
          nextTrack(); // call your existing nextTrack function
        }
      });


      // Note: Without the IFrame API we cannot detect video end, so "nextTrack" will not auto‚Äëtrigger reliably.
    }

    function prevTrack(){
      if(queue.length === 0) return;
      if(currentIndex > 0) playIndex(currentIndex - 1);
      else if(repeatMode === 1) playIndex(queue.length - 1);
      else playIndex(0);
    }
    function nextTrack(){
      if(queue.length === 0) return;
      if(repeatMode === 2) playIndex(currentIndex);
      else if(currentIndex + 1 < queue.length) playIndex(currentIndex + 1);
      else if(repeatMode === 1) playIndex(0);
      else {
        currentIndex = -1; isPlaying = false; updatePlayPauseBtn();
        document.getElementById('playerTitle').textContent = 'Not playing';
        document.getElementById('playerArtist').textContent = '‚Äî';
        document.getElementById('playerThumb').src = '';
        embedIframe.src = "";
        updateQueueUI();
      }
    }
    

    // Controls
    function updatePlayPauseBtn(){
      document.getElementById('playPauseBtn').textContent = isPlaying ? '‚è∏' : '‚ñ∂Ô∏è';
    }
    document.getElementById('playPauseBtn').addEventListener('click', ()=>{
      // Note: With embed only, we cannot reliably pause/resume unless using the JS API
      if(isPlaying){
        embedIframe.src = embedIframe.src.replace('?autoplay=1','?autoplay=0');
        isPlaying = false;
      } else {
        if(currentIndex === -1 && queue.length>0){ playIndex(0); return; }
        embedIframe.src = queue[currentIndex] 
          ? `https://www.youtube.com/embed/${queue[currentIndex].videoId}?autoplay=1&rel=0&modestbranding=1`
          : "";
        isPlaying = true;
      }
      updatePlayPauseBtn();
    });
    document.getElementById('nextBtn').addEventListener('click', nextTrack);
    document.getElementById('prevBtn').addEventListener('click', prevTrack);

    // Repeat
    const repeatBtn = document.getElementById('repeatBtn');
    repeatBtn.addEventListener('click', ()=>{
      repeatMode = (repeatMode + 1) % 3;
      repeatBtn.textContent = repeatIcons[repeatMode];
    });

    // Shuffle
    document.getElementById('shuffleBtn').addEventListener('click', ()=>{
      if(queue.length <= 1) return customAlert("Need at least 2 songs to shuffle.");
      const currentVid = currentIndex !== -1 ? queue[currentIndex].videoId : null;
      for(let i = queue.length -1; i>0; i--){
        const j = Math.floor(Math.random() * (i+1));
        [queue[i], queue[j]] = [queue[j], queue[i]];
      }
      if(currentVid){
        const newIdx = queue.findIndex(t=>t.videoId===currentVid);
        if(newIdx !== -1) currentIndex = newIdx;
      }
      updateQueueUI(); saveQueueToLocal();
      customAlert("Queue Shuffled!");
    });

    // LocalStorage for queue
    function saveQueueToLocal(){
      localStorage.setItem('BOIMUSIC_QUEUE', JSON.stringify(queue.map(t=>t.videoId)));
    }
    function loadQueueFromLocal(){
      const saved = JSON.parse(localStorage.getItem('BOIMUSIC_QUEUE') || '[]');
      if(saved.length){
        saved.forEach(vid=>{
          queue.push({ videoId:vid, title:"Loading...", channel:"", thumb:"" });
        });
        updateQueueUI();
        if(queue.length) playIndex(0);
        saved.forEach((vid,i)=>{
          fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${vid}&format=json`)
            .then(r=>r.json()).then(d=>{
              if(queue[i]){
                queue[i].title = d.title;
                queue[i].channel = d.author_name;
                queue[i].thumb = d.thumbnail_url;
                updateQueueUI();
              }
            }).catch(()=>{});
        });
      }
    }

    // Playlists
    function savePlaylistsToLocal(){ localStorage.setItem('BOIMUSIC_PLAYLISTS', JSON.stringify(playlists)); }
    function updatePlaylistsSidebar(){
      const c = document.getElementById('playlistsList');
      c.innerHTML='';
      const names = Object.keys(playlists);
      if(!names.length){
        c.innerHTML=`<div class="muted small">No playlists ‚Äî create one</div>`;
        return;
      }
      names.forEach(name=>{
        const el = document.createElement('div');
        el.className='playlist-item';
        el.textContent=name;
        el.addEventListener('click', ()=> openPlaylistDrawer(name));
        c.appendChild(el);
      });
    }

    const dialog = document.getElementById('customDialog');
    const messageEl = document.getElementById('customDialogMessage');
    const inputEl = document.getElementById('customDialogInput');
    const okBtn   = document.getElementById('customDialogOk');
    const cancelBtn= document.getElementById('customDialogCancel');

    function customAlert(msg, callback){
      messageEl.textContent = msg;
      inputEl.style.display='none';
      cancelBtn.style.display='none';
      dialog.style.display='flex';
      okBtn.onclick = ()=>{
        dialog.style.display='none';
        if(callback) callback();
      };
    }
    function customConfirm(msg, callback){
      messageEl.textContent = msg;
      inputEl.style.display='none';
      cancelBtn.style.display='inline-block';
      dialog.style.display='flex';
      okBtn.onclick = ()=>{ dialog.style.display='none'; callback(true); };
      cancelBtn.onclick = ()=>{ dialog.style.display='none'; callback(false); };
    }
    function customPrompt(msg, callback){
      messageEl.textContent = msg;
      inputEl.style.display='block';
      inputEl.value='';
      cancelBtn.style.display='inline-block';
      dialog.style.display='flex';
      okBtn.onclick = ()=>{ dialog.style.display='none'; callback(inputEl.value); };
      cancelBtn.onclick = ()=>{ dialog.style.display='none'; callback(null); };
    }

    function openPlaylistDrawer(name){
      selectedPlaylist = name || selectedPlaylist;
      document.getElementById('selectedPlaylistName').textContent = selectedPlaylist || 'None';
      renderPlaylistSelectOptions();
      renderSelectedPlaylist();
      document.getElementById('playlistDrawer').classList.add('open');
      document.getElementById('fadeOverlay').classList.add('visible');
      document.querySelector('.left-main').style.flex='0 0 50%';
    }
    function closePlaylistDrawer(){
      document.getElementById('playlistDrawer').classList.remove('open');
      document.getElementById('fadeOverlay').classList.remove('visible');
      document.querySelector('.left-main').style.flex='1';
    }
    document.getElementById('closeDrawerBtn').addEventListener('click', closePlaylistDrawer);
    document.getElementById('closeDrawerBtnFooter').addEventListener('click', closePlaylistDrawer);
    document.getElementById('fadeOverlay').addEventListener('click', closePlaylistDrawer);

    function renderPlaylistSelectOptions(){
      const sel = document.getElementById('playlistAddSelect');
      sel.innerHTML='';
      const names = Object.keys(playlists);
      if(names.length === 0){
        const opt = document.createElement('option');
        opt.value='';
        opt.textContent='(no playlists)';
        sel.appendChild(opt);
        sel.disabled=true;
        return;
      }
      sel.disabled=false;
      names.forEach(n=>{
        const o = document.createElement('option');
        o.value = n;
        o.textContent = n;
        sel.appendChild(o);
      });
      if(selectedPlaylist) sel.value = selectedPlaylist;
    }
    function renderSelectedPlaylist(){
      const box = document.getElementById('playlistSongs');
      box.innerHTML='';
      if(!selectedPlaylist || !playlists[selectedPlaylist]){
        box.innerHTML = `<div class="muted small">No playlist selected</div>`;
        return;
      }
      const songs = playlists[selectedPlaylist];
      if(!songs.length){
        box.innerHTML = `<div class="muted small">Playlist is empty</div>`;
        return;
      }
      songs.forEach((track, idx)=>{
        const row = document.createElement('div'); row.className='playlist-song';
        row.innerHTML = `
          <div style="display:flex;align-items:center">
            <img src="${track.thumb}" style="width:48px;height:48px;border-radius:6px;object-fit:cover">
            <div class="song-meta">
              <div style="font-weight:600">${track.title}</div>
              <div class="muted small">${track.channel}</div>
            </div>
          </div>`;
        const actions = document.createElement('div'); actions.className='song-actions';
        const playBtn = document.createElement('button'); playBtn.className='btn'; playBtn.textContent='Play';
        playBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          addToQueue(track); playIndex(queue.length-1);
        });
        const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='Delete';
        delBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          customConfirm(`Remove "${track.title}" from "${selectedPlaylist}"?`, (result)=>{
            if(!result) return;
            playlists[selectedPlaylist].splice(idx,1);
            savePlaylistsToLocal();
            renderSelectedPlaylist();
          });
        });
        actions.appendChild(playBtn); actions.appendChild(delBtn);
        row.appendChild(actions);
        box.appendChild(row);
      });
    }

    document.getElementById('newPlaylistBtn').addEventListener('click', ()=>{
      customPrompt('Enter a new playlist name:', (name)=>{
        if(!name) return;
        if(playlists[name]) return customAlert('A playlist with that name already exists.');
        playlists[name]=[];
        savePlaylistsToLocal();
        updatePlaylistsSidebar();
        openPlaylistDrawer(name);
      });
    });
    document.getElementById('deletePlaylistBtn').addEventListener('click', ()=>{
      customPrompt('Type the exact playlist name to delete:', (name)=>{
        if(!name) return;
        if(!playlists[name]) { customAlert('Playlist not found!'); return; }
        customConfirm(`Are you sure you want to delete "${name}"? This cannot be undone.`, (result)=>{
          if(!result) return;
          delete playlists[name];
          savePlaylistsToLocal();
          if(selectedPlaylist === name) selectedPlaylist = null;
          document.getElementById('selectedPlaylistName').textContent = selectedPlaylist || 'None';
          updatePlaylistsSidebar();
          renderSelectedPlaylist();
        });
      });
    });
    document.getElementById('addCurrentToSelectedBtn').addEventListener('click', ()=>{
      if(currentIndex === -1) return customAlert('No song is currently playing.');
      const sel = document.getElementById('playlistAddSelect');
      if(sel.disabled) return customAlert('Create a playlist first.');
      const chosen = sel.value;
      if(!chosen) return customAlert('Select a playlist.');
      const playing = queue[currentIndex];
      playlists[chosen].push({
        videoId: playing.videoId,
        title: playing.title,
        channel: playing.channel,
        thumb: playing.thumb
      });
      savePlaylistsToLocal();
      if(selectedPlaylist === chosen) renderSelectedPlaylist();
      customAlert(`Added "${playing.title}" to "${chosen}"`);
    });
    document.getElementById('createPlaylistFromDrawerBtn').addEventListener('click', ()=>{
      customPrompt('Enter a name for the new playlist:', (name)=>{
        if(!name) return;
        if(playlists[name]) { customAlert('Already exists.'); return; }
        playlists[name] = [];
        savePlaylistsToLocal();
        updatePlaylistsSidebar();
        renderPlaylistSelectOptions();
        openPlaylistDrawer(name);
      });
    });
    document.getElementById('playPlaylistBtn').addEventListener('click', ()=>{
      if(!selectedPlaylist) return customAlert('Select a playlist from the left first.');
      const list = playlists[selectedPlaylist] || [];
      if(!list.length) return customAlert('Playlist is empty.');
      queue = list.map(t=>({ videoId:t.videoId, title:t.title, channel:t.channel, thumb:t.thumb }));
      saveQueueToLocal();
      updateQueueUI();
      playIndex(0);
      repeatMode = playlistRepeat ? 1 : 0;
      repeatBtn.textContent = repeatIcons[repeatMode];
      closePlaylistDrawer();
    });
    document.getElementById('togglePlaylistRepeatBtn').addEventListener('click', ()=>{
      playlistRepeat = !playlistRepeat;
      document.getElementById('playlistRepeatState').textContent = playlistRepeat ? 'On' : 'Off';
    });
    document.getElementById('addToPlaylistBtn').addEventListener('click', ()=>{
      if(currentIndex === -1) return customAlert('No song is currently playing.');
      if(!document.getElementById('playlistDrawer').classList.contains('open')){
        const names = Object.keys(playlists);
        if(names.length) openPlaylistDrawer(names[0]);
        else openPlaylistDrawer(null);
      } else {
        // Already open: maybe focus the select
        document.getElementById('playlistAddSelect').focus();
      }
    });

    // Init
    window.onload = () => {
      loadQueueFromLocal();
      updatePlaylistsSidebar();
      renderSelectedPlaylist();
    };
  </script>
</body>
</html>
